name: PR test CI

on:
  pull_request:
    branches: [ "master", "develop" ]

jobs:
  build:
    runs-on: [self-hosted, Linux]

    permissions:
      contents: read
      packages: write
      attestations: write
      id-token: write

    steps:
      # Step 1: Checkout the repository
      - name: Checkout Code
        uses: actions/checkout@v4
      # Step 2: Log in to GitHub Container Registry (optional)
      # If you need to push the built image, authenticate here.
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GIT_ACCESS_TOKEN }}

      # Step 3: Pull the Cached Image
      - name: Pull Cached Image & Set environment
        env:
          GIT_ACCESS_TOKEN: ${{ secrets.GIT_ACCESS_TOKEN }}
        run: |
          docker pull ghcr.io/psal-postech/torchsim_base:latest || echo "No cache available"
          echo "IMAGE_TAG=torchsim-ci:${GITHUB_SHA}" >> $GITHUB_ENV
          echo "GITHUB_SHA=${{github.event.pull_request.head.sha}}" >> $GITHUB_ENV
          echo "GITHUB_SHA=${{github.event.pull_request.head.sha}}"
          gem5_response_file=/tmp/releases-gem5-latest.json
          response=$(curl -sH "Authorization: Bearer ${GIT_ACCESS_TOKEN}" https://api.github.com/repos/PSAL-POSTECH/GEM5/releases/latest > ${gem5_response_file} )
          GEM5_ASSET_ID=$(cat ${gem5_response_file} | jq ".assets[0]."id"")
          echo "GEM5_ASSET_ID=$GEM5_ASSET_ID"
          echo "GEM5_ASSET_ID=$GEM5_ASSET_ID" >> $GITHUB_ENV

          llvm_response_file=/tmp/releases-gem5-latest.json
          response=$(curl -sH "Authorization: Bearer ${GIT_ACCESS_TOKEN}" https://api.github.com/repos/PSAL-POSTECH/llvm-project/releases/latest > ${llvm_response_file} )
          LLVM_ASSET_ID=$(cat ${llvm_response_file} | jq ".assets[0]."id"")
          echo "LLVM_ASSET_ID=$LLVM_ASSET_ID"
          echo "LLVM_ASSET_ID=$LLVM_ASSET_ID" >> $GITHUB_ENV

          mkdir -p /tmp/torchsim-ci/${GITHUB_SHA}
          echo "DUMP_PATH=/tmp/torchsim-ci/${GITHUB_SHA}"

      # Step 4: Build and Push Docker Image
      - name: Build and Push Docker Image
        uses: docker/build-push-action@v4
        env:
          GIT_ACCESS_TOKEN: ${{ secrets.GIT_ACCESS_TOKEN }}
        with:
          context: .
          file: ./Dockerfile
          push: true
          build-args: |
            GEM5_ASSET_ID=${{ env.GEM5_ASSET_ID }}
            LLVM_ASSET_ID=${{ env.LLVM_ASSET_ID }}
            GIT_ACCESS_TOKEN=${{ env.GIT_ACCESS_TOKEN }}
            TORCHSIM_SHA=${{ env.GITHUB_SHA }}
          tags: ghcr.io/psal-postech/${{ env.IMAGE_TAG}}

  test_add:
    name: Run test_add.py
    runs-on: self-hosted

    permissions:
      contents: read
      packages: write
      attestations: write
      id-token: write
    needs: build

    steps:
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GIT_ACCESS_TOKEN }}
      - name: Run test_add.py
        env:
          GIT_ACCESS_TOKEN: ${{ secrets.GIT_ACCESS_TOKEN }}
        run: |
          echo "Running test_add.py"
          docker run --rm \
            -v /tmp/torchsim-ci/${GITHUB_SHA}:/dump \
            -e TORCHSIM_DUMP_PATH=/dump \
            ghcr.io/psal-postech/torchsim-ci:${GITHUB_SHA} python3 PyTorchSim/tests/test_add.py

  test_activation:
    name: Run test_activation.py
    runs-on: self-hosted
    needs: build
    steps:
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GIT_ACCESS_TOKEN }}
      - name: Run test_activation.py
        env:
          GIT_ACCESS_TOKEN: ${{ secrets.GIT_ACCESS_TOKEN }}
        run: |
          echo "Running test_activation.py"
          docker run --rm \
            -v /tmp/torchsim-ci/${GITHUB_SHA}:/dump \
            -e TORCHSIM_DUMP_PATH=/dump \
            ghcr.io/psal-postech/torchsim-ci:${GITHUB_SHA} python3 PyTorchSim/tests/test_activation.py

  test_batchnorm:
    name: Run test_batchnorm.py
    runs-on: self-hosted
    needs: build
    steps:
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GIT_ACCESS_TOKEN }}
      - name: Run test_batchnorm.py
        env:
          GIT_ACCESS_TOKEN: ${{ secrets.GIT_ACCESS_TOKEN }}
        run: |
          echo "Running test_batchnorm.py"
          docker run --rm \
            -v /tmp/torchsim-ci/${GITHUB_SHA}:/dump \
            -e TORCHSIM_DUMP_PATH=/dump \
            ghcr.io/psal-postech/torchsim-ci:${GITHUB_SHA} python3 PyTorchSim/tests/test_batchnorm.py

  test_bmm:
    name: Run test_bmm.py
    runs-on: self-hosted
    needs: build
    steps:
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GIT_ACCESS_TOKEN }}
      - name: Run test_bmm.py
        env:
          GIT_ACCESS_TOKEN: ${{ secrets.GIT_ACCESS_TOKEN }}
        run: |
          echo "Running test_bmm.py"
          docker run --rm \
            -v /tmp/torchsim-ci/${GITHUB_SHA}:/dump \
            -e TORCHSIM_DUMP_PATH=/dump \
            ghcr.io/psal-postech/torchsim-ci:${GITHUB_SHA} python3 PyTorchSim/tests/test_bmm.py

  test_cnn:
    name: Run test_cnn.py
    runs-on: self-hosted
    needs: build
    steps:
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GIT_ACCESS_TOKEN }}
      - name: Run test_cnn.py
        env:
          GIT_ACCESS_TOKEN: ${{ secrets.GIT_ACCESS_TOKEN }}
        run: |
          echo "Running test_cnn.py"
          docker run --rm \
            -v /tmp/torchsim-ci/${GITHUB_SHA}:/dump \
            -e TORCHSIM_DUMP_PATH=/dump \
            ghcr.io/psal-postech/torchsim-ci:${GITHUB_SHA} python3 PyTorchSim/tests/test_cnn.py

  test_conv2d:
    name: Run test_conv2d.py
    runs-on: self-hosted
    needs: build
    steps:
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GIT_ACCESS_TOKEN }}
      - name: Run test_conv2d.py
        env:
          GIT_ACCESS_TOKEN: ${{ secrets.GIT_ACCESS_TOKEN }}
        run: |
          echo "Running test_conv2d.py"
          docker run --rm \
            -v /tmp/torchsim-ci/${GITHUB_SHA}:/dump \
            -e TORCHSIM_DUMP_PATH=/dump \
            ghcr.io/psal-postech/torchsim-ci:${GITHUB_SHA} python3 PyTorchSim/tests/test_conv2d.py

  test_matmul:
    name: Run test_matmul.py
    runs-on: self-hosted
    needs: build
    steps:
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GIT_ACCESS_TOKEN }}
      - name: Run test_matmul.py
        env:
          GIT_ACCESS_TOKEN: ${{ secrets.GIT_ACCESS_TOKEN }}
        run: |
          echo "Running test_matmul.py"
          docker run --rm \
            -v /tmp/torchsim-ci/${GITHUB_SHA}:/dump \
            -e TORCHSIM_DUMP_PATH=/dump \
            ghcr.io/psal-postech/torchsim-ci:${GITHUB_SHA} python3 PyTorchSim/tests/test_matmul.py

  test_reduce:
    name: Run test_reduce.py
    runs-on: self-hosted
    needs: build
    steps:
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GIT_ACCESS_TOKEN }}
      - name: Run test_reduce.py
        env:
          GIT_ACCESS_TOKEN: ${{ secrets.GIT_ACCESS_TOKEN }}
        run: |
          echo "Running test_reduce.py"
          docker run --rm \
            -v /tmp/torchsim-ci/${GITHUB_SHA}:/dump \
            -e TORCHSIM_DUMP_PATH=/dump \
            ghcr.io/psal-postech/torchsim-ci:${GITHUB_SHA} python3 PyTorchSim/tests/test_reduce.py

  test_softmax:
    name: Run test_softmax.py
    runs-on: self-hosted
    needs: build
    steps:
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GIT_ACCESS_TOKEN }}
      - name: Run test_softmax.py
        env:
          GIT_ACCESS_TOKEN: ${{ secrets.GIT_ACCESS_TOKEN }}
        run: |
          echo "Running test_softmax.py"
          docker run --rm \
            -v /tmp/torchsim-ci/${GITHUB_SHA}:/dump \
            -e TORCHSIM_DUMP_PATH=/dump \
            ghcr.io/psal-postech/torchsim-ci:${GITHUB_SHA} python3 PyTorchSim/tests/test_softmax.py

  test_transpose2D:
    name: Run test_transpose2D.py
    runs-on: self-hosted
    needs: build
    steps:
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GIT_ACCESS_TOKEN }}
      - name: Run test_transpose2D.py
        env:
          GIT_ACCESS_TOKEN: ${{ secrets.GIT_ACCESS_TOKEN }}
        run: |
          echo "Running test_transpose2D.py"
          docker run --rm \
            -v /tmp/torchsim-ci/${GITHUB_SHA}:/dump \
            -e TORCHSIM_DUMP_PATH=/dump \
            ghcr.io/psal-postech/torchsim-ci:${GITHUB_SHA} python3 PyTorchSim/tests/test_transpose2D.py

  test_view3D_2D:
    name: Run test_view3D_2D.py
    runs-on: self-hosted
    needs: build
    steps:
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GIT_ACCESS_TOKEN }}
      - name: Run test_view3D_2D.py
        env:
          GIT_ACCESS_TOKEN: ${{ secrets.GIT_ACCESS_TOKEN }}
        run: |
          echo "Running test_view3D_2D.py"
          docker run --rm \
            -v /tmp/torchsim-ci/${GITHUB_SHA}:/dump \
            -e TORCHSIM_DUMP_PATH=/dump \
            ghcr.io/psal-postech/torchsim-ci:${GITHUB_SHA} python3 PyTorchSim/tests/test_view3D_2D.py

  test_layernorm:
    name: Run test_layernorm.py
    runs-on: self-hosted
    needs: build
    steps:
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GIT_ACCESS_TOKEN }}
      - name: Run test_layernorm.py
        env:
          GIT_ACCESS_TOKEN: ${{ secrets.GIT_ACCESS_TOKEN }}
        run: |
          echo "Running test_layernorm.py"
          docker run --rm \
            -v /tmp/torchsim-ci/${GITHUB_SHA}:/dump \
            -e TORCHSIM_DUMP_PATH=/dump \
            ghcr.io/psal-postech/torchsim-ci:${GITHUB_SHA} python3 PyTorchSim/tests/test_layernorm.py

  test_mlp:
    name: Run test_mlp.py
    runs-on: self-hosted
    needs: build
    steps:
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GIT_ACCESS_TOKEN }}
      - name: Run test_mlp.py
        env:
          GIT_ACCESS_TOKEN: ${{ secrets.GIT_ACCESS_TOKEN }}
        run: |
          echo "Running test_mlp.py"
          docker run --rm \
            -v /tmp/torchsim-ci/${GITHUB_SHA}:/dump \
            -e TORCHSIM_DUMP_PATH=/dump \
            ghcr.io/psal-postech/torchsim-ci:${GITHUB_SHA} python3 PyTorchSim/tests/test_mlp.py

  test_resnet:
    name: Run test_resnet.py
    runs-on: self-hosted
    needs: build
    steps:
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GIT_ACCESS_TOKEN }}
      - name: Run test_resnet.py
        env:
          GIT_ACCESS_TOKEN: ${{ secrets.GIT_ACCESS_TOKEN }}
        run: |
          echo "Running test_resnet.py"
          docker run --rm \
            -v /tmp/torchsim-ci/${GITHUB_SHA}:/dump \
            -e TORCHSIM_DUMP_PATH=/dump \
            ghcr.io/psal-postech/torchsim-ci:${GITHUB_SHA} python3 PyTorchSim/tests/test_resnet.py

  test_transformer:
    name: Run test_transformer.py
    runs-on: self-hosted
    needs: build
    steps:
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GIT_ACCESS_TOKEN }}
      - name: Run test_transformer.py
        env:
          GIT_ACCESS_TOKEN: ${{ secrets.GIT_ACCESS_TOKEN }}
        run: |
          echo "Running test_transformer.py"
          docker run --rm \
            -v /tmp/torchsim-ci/${GITHUB_SHA}:/dump \
            -e TORCHSIM_DUMP_PATH=/dump \
            ghcr.io/psal-postech/torchsim-ci:${GITHUB_SHA} python3 PyTorchSim/tests/test_transformer.py

  test_transpose3D:
    name: Run test_transpose3D.py
    runs-on: self-hosted
    needs: build
    steps:
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GIT_ACCESS_TOKEN }}
      - name: Run test_transpose3D.py
        env:
          GIT_ACCESS_TOKEN: ${{ secrets.GIT_ACCESS_TOKEN }}
        run: |
          echo "Running test_transpose3D.py"
          docker run --rm \
            -v /tmp/torchsim-ci/${GITHUB_SHA}:/dump \
            -e TORCHSIM_DUMP_PATH=/dump \
            ghcr.io/psal-postech/torchsim-ci:${GITHUB_SHA} python3 PyTorchSim/tests/test_transpose3D.py

  test_sparsity:
    name: Run test_sparsity.py
    runs-on: self-hosted
    needs: build
    steps:
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GIT_ACCESS_TOKEN }}
      - name: Run test_sparsity.py
        env:
          GIT_ACCESS_TOKEN: ${{ secrets.GIT_ACCESS_TOKEN }}
        run: |
          echo "Running test_sparsity.py"
          docker run --rm \
            -v /tmp/torchsim-ci/${GITHUB_SHA}:/dump \
            -e TORCHSIM_DUMP_PATH=/dump \
            ghcr.io/psal-postech/torchsim-ci:${GITHUB_SHA} python3 PyTorchSim/tests/test_sparsity.py

  test_pool:
    name: Run test_pool.py
    runs-on: self-hosted
    needs: build
    steps:
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GIT_ACCESS_TOKEN }}
      - name: Run test_pool.py
        env:
          GIT_ACCESS_TOKEN: ${{ secrets.GIT_ACCESS_TOKEN }}
        run: |
          echo "Running test_pool.py"
          docker run --rm \
            -v /tmp/torchsim-ci/${GITHUB_SHA}:/dump \
            -e TORCHSIM_DUMP_PATH=/dump \
            ghcr.io/psal-postech/torchsim-ci:${GITHUB_SHA} python3 PyTorchSim/tests/test_pool.py

  test_perceptron:
    name: Run test_perceptron.py
    runs-on: self-hosted
    needs: build
    steps:
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GIT_ACCESS_TOKEN }}
      - name: Run test_single_perceptron.py
        env:
          GIT_ACCESS_TOKEN: ${{ secrets.GIT_ACCESS_TOKEN }}
        run: |
          echo "Running test_single_perceptron.py"
          docker run --rm \
            -v /tmp/torchsim-ci/${GITHUB_SHA}:/dump \
            -e TORCHSIM_DUMP_PATH=/dump \
            ghcr.io/psal-postech/torchsim-ci:${GITHUB_SHA} python3 PyTorchSim/tests/test_single_perceptron.py

  test_fusion:
    name: Run test_fusion
    runs-on: self-hosted
    needs: build
    steps:
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GIT_ACCESS_TOKEN }}
      - name: Run test_addmm_residual.py
        env:
          GIT_ACCESS_TOKEN: ${{ secrets.GIT_ACCESS_TOKEN }}
        run: |
          echo "Running test_addmm_residual.py"
          docker run --rm \
            -v /tmp/torchsim-ci/${GITHUB_SHA}:/dump \
            -e TORCHSIM_DUMP_PATH=/dump \
            ghcr.io/psal-postech/torchsim-ci:${GITHUB_SHA} python3 PyTorchSim/tests/Fusion/test_addmm_residual.py

      - name: Run test_matmul_activation.py
        env:
          GIT_ACCESS_TOKEN: ${{ secrets.GIT_ACCESS_TOKEN }}
        run: |
          echo "Running test_matmul_activation.py"
          docker run --rm \
            -v /tmp/torchsim-ci/${GITHUB_SHA}:/dump \
            -e TORCHSIM_DUMP_PATH=/dump \
            ghcr.io/psal-postech/torchsim-ci:${GITHUB_SHA} python3 PyTorchSim/tests/Fusion/test_matmul_activation.py

      - name: Run test_matmul_scalar.py
        env:
          GIT_ACCESS_TOKEN: ${{ secrets.GIT_ACCESS_TOKEN }}
        run: |
          echo "Running test_matmul_scalar.py"
          docker run --rm \
            -v /tmp/torchsim-ci/${GITHUB_SHA}:/dump \
            -e TORCHSIM_DUMP_PATH=/dump \
            ghcr.io/psal-postech/torchsim-ci:${GITHUB_SHA} python3 PyTorchSim/tests/Fusion/test_matmul_scalar.py

      - name: Run test_matmul_reduction.py
        env:
          GIT_ACCESS_TOKEN: ${{ secrets.GIT_ACCESS_TOKEN }}
        run: |
          echo "Running test_matmul_reduction.py"
          docker run --rm \
            -v /tmp/torchsim-ci/${GITHUB_SHA}:/dump \
            -e TORCHSIM_DUMP_PATH=/dump \
            ghcr.io/psal-postech/torchsim-ci:${GITHUB_SHA} python3 PyTorchSim/tests/Fusion/test_matmul_reduction.py

      - name: Run test_bmm_reduction.py
        env:
          GIT_ACCESS_TOKEN: ${{ secrets.GIT_ACCESS_TOKEN }}
        run: |
          echo "Running test_bmm_reduction.py"
          docker run --rm \
            -v /tmp/torchsim-ci/${GITHUB_SHA}:/dump \
            -e TORCHSIM_DUMP_PATH=/dump \
            ghcr.io/psal-postech/torchsim-ci:${GITHUB_SHA} python3 PyTorchSim/tests/Fusion/test_bmm_reduction.py

      - name: Run test_prologue_fusion.py
        env:
          GIT_ACCESS_TOKEN: ${{ secrets.GIT_ACCESS_TOKEN }}
        run: |
          echo "Running test_prologue_fusion.py"
          docker run --rm \
            -v /tmp/torchsim-ci/${GITHUB_SHA}:/dump \
            -e TORCHSIM_DUMP_PATH=/dump \
            ghcr.io/psal-postech/torchsim-ci:${GITHUB_SHA} python3 PyTorchSim/tests/Fusion/test_prologue_fusion.py

      - name: Run test_transformer_fusion.py
        env:
          GIT_ACCESS_TOKEN: ${{ secrets.GIT_ACCESS_TOKEN }}
        run: |
          echo "Running test_transformer_fusion.py"
          docker run --rm \
            -v /tmp/torchsim-ci/${GITHUB_SHA}:/dump \
            -e TORCHSIM_DUMP_PATH=/dump \
            ghcr.io/psal-postech/torchsim-ci:${GITHUB_SHA} python3 PyTorchSim/tests/Fusion/test_transformer_fusion.py

      - name: Run test_conv_fusion.py
        env:
          GIT_ACCESS_TOKEN: ${{ secrets.GIT_ACCESS_TOKEN }}
        run: |
          echo "Running test_conv_fusion.py"
          docker run --rm \
            -v /tmp/torchsim-ci/${GITHUB_SHA}:/dump \
            -e TORCHSIM_DUMP_PATH=/dump \
            ghcr.io/psal-postech/torchsim-ci:${GITHUB_SHA} python3 PyTorchSim/tests/Fusion/test_conv_fusion.py

  test_moe:
    name: Run test_moe
    runs-on: self-hosted
    needs: build
    steps:
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GIT_ACCESS_TOKEN }}
      - name: Run test_moe.py
        env:
          GIT_ACCESS_TOKEN: ${{ secrets.GIT_ACCESS_TOKEN }}
        run: |
          echo "Running test_moe.py"
          docker run --rm \
            -v /tmp/torchsim-ci/${GITHUB_SHA}:/dump \
            -e TORCHSIM_DUMP_PATH=/dump \
            ghcr.io/psal-postech/torchsim-ci:${GITHUB_SHA} python3 PyTorchSim/tests/MoE/test_moe.py

  test_mistral:
    name: Run test_mistral
    runs-on: self-hosted
    needs: build
    steps:
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GIT_ACCESS_TOKEN }}
      - name: Run test_mistral.py
        env:
          GIT_ACCESS_TOKEN: ${{ secrets.GIT_ACCESS_TOKEN }}
        run: |
          echo "Running test_mistral.py"
          docker run --rm \
            -v /tmp/torchsim-ci/${GITHUB_SHA}:/dump \
            -e TORCHSIM_DUMP_PATH=/dump \
            ghcr.io/psal-postech/torchsim-ci:${GITHUB_SHA} python3 PyTorchSim/tests/Mixtral_8x7B/test_attention.py

  test_indirect:
    name: Run test_indirect
    runs-on: self-hosted
    needs: build
    env:
      GIT_ACCESS_TOKEN: ${{ secrets.GIT_ACCESS_TOKEN }}
    steps:
      - name: Run test_indirect.py
        run: |
          echo "Running test_indirect.py"
          echo $GIT_ACCESS_TOKEN | docker login ghcr.io -u USERNAME --password-stdin
          docker run --rm \
            -v /tmp/torchsim-ci/${GITHUB_SHA}:/dump \
            -e TORCHSIM_DUMP_PATH=/dump \
            ghcr.io/psal-postech/torchsim-ci:${GITHUB_SHA} python3 PyTorchSim/tests/test_indirect_access.py

  test_scheduler:
    name: Run test_scheduler
    runs-on: self-hosted
    needs: build
    env:
      GIT_ACCESS_TOKEN: ${{ secrets.GIT_ACCESS_TOKEN }}
    steps:
      - name: Run test_scheduler.py
        run: |
          echo "Running test_scheduler.py"
          echo $GIT_ACCESS_TOKEN | docker login ghcr.io -u USERNAME --password-stdin
          docker run --rm \
            -v /tmp/torchsim-ci/${GITHUB_SHA}:/dump \
            -e TORCHSIM_DUMP_PATH=/dump \
            ghcr.io/psal-postech/torchsim-ci:${GITHUB_SHA} python3 PyTorchSim/tests/test_scheduler.py

  test_cleanup:
    name: Clean test cases
    runs-on: self-hosted
    needs: [test_add, test_batchnorm, test_bmm, test_cnn, test_conv2d,
            test_matmul, test_reduce, test_softmax,
            test_transpose2D, test_view3D_2D, test_layernorm,
            test_mlp, test_resnet, test_transformer, test_transpose3D,
            test_sparsity, test_activation, test_pool, test_perceptron,
            test_fusion, test_mistral, test_moe, test_indirect, test_scheduler]
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      - name: Clean test case
        run: |
          docker run --rm \
            -v /tmp/torchsim-ci/${GITHUB_SHA}:/dump \
            ghcr.io/psal-postech/torchsim-ci:${GITHUB_SHA} chown -R $(id -u):$(id -g) /dump